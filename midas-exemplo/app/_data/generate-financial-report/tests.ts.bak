import { Transaction } from './types';
import { classifyTransaction } from './classification';
import { detectAnomalies } from './anomaly-detection';
import { detectRecurringTransactions } from './recurrence-analysis';
import { generateFinancialReport } from './index';

// Dados de teste baseados no exemplo fornecido
const testTransactions: Transaction[] = [
  {
    id: "1",
    date: "2025-09-08",
    amount: 10000,
    merchant: "SalÃ¡rio Empresa X",
    category: "SALARY",
    payment_method: "PIX",
    transaction_type: "DEPOSIT"
  },
  {
    id: "2", 
    date: "2025-09-10",
    amount: -300,
    merchant: "Mercado",
    category: "FOOD",
    payment_method: "CASH",
    transaction_type: "EXPENSE"
  },
  {
    id: "3",
    date: "2025-09-11", 
    amount: -6666,
    merchant: "Gacha",
    category: "OTHER",
    payment_method: "PIX",
    transaction_type: "EXPENSE"
  }
];

describe('Sistema de RelatÃ³rios Financeiros Melhorado', () => {
  
  describe('ClassificaÃ§Ã£o de TransaÃ§Ãµes', () => {
    test('deve classificar salÃ¡rio como receita com alta confianÃ§a', () => {
      const transaction = testTransactions[0]; // SalÃ¡rio
      const classification = classifyTransaction(transaction);
      
      expect(classification.is_income).toBe(true);
      expect(classification.confidence).toBe('alta');
      expect(classification.reason).toContain('SalÃ¡rio');
    });

    test('deve classificar despesa como despesa', () => {
      const transaction = testTransactions[1]; // Mercado
      const classification = classifyTransaction(transaction);
      
      expect(classification.is_income).toBe(false);
      expect(classification.confidence).toBe('alta');
    });

    test('deve detectar transaÃ§Ã£o suspeita (Gacha)', () => {
      const transaction = testTransactions[2]; // Gacha
      const classification = classifyTransaction(transaction);
      
      expect(classification.is_income).toBe(false);
      // Deve detectar como suspeita devido ao merchant "Gacha"
    });
  });

  describe('DetecÃ§Ã£o de Anomalias', () => {
    test('deve detectar transaÃ§Ã£o anÃ´mala (valor alto)', () => {
      const anomalies = detectAnomalies(testTransactions, 10000, 6966);
      
      // Deve detectar a transaÃ§Ã£o do Gacha como anÃ´mala
      const gachaAnomaly = anomalies.find(a => a.merchant === "Gacha");
      expect(gachaAnomaly).toBeDefined();
      expect(gachaAnomaly?.reason).toContain('valor muito acima');
    });

    test('nÃ£o deve classificar salÃ¡rio como despesa', () => {
      const anomalies = detectAnomalies(testTransactions, 10000, 6966);
      
      // NÃ£o deve haver anomalia de salÃ¡rio em despesas
      const salaryAnomaly = anomalies.find(a => 
        a.merchant.includes("SalÃ¡rio") && a.reason.includes("despesa")
      );
      expect(salaryAnomaly).toBeUndefined();
    });
  });

  describe('AnÃ¡lise de RecorrÃªncia', () => {
    test('deve detectar transaÃ§Ãµes recorrentes', () => {
      // Adicionar mais transaÃ§Ãµes para testar recorrÃªncia
      const recurringTransactions: Transaction[] = [
        {
          id: "4",
          date: "2025-09-01",
          amount: -150,
          merchant: "Netflix",
          category: "ENTERTAINMENT",
          payment_method: "CREDIT_CARD",
          transaction_type: "EXPENSE"
        },
        {
          id: "5", 
          date: "2025-08-01",
          amount: -150,
          merchant: "Netflix",
          category: "ENTERTAINMENT", 
          payment_method: "CREDIT_CARD",
          transaction_type: "EXPENSE"
        }
      ];
      
      const recurring = detectRecurringTransactions(recurringTransactions);
      
      const netflixRecurring = recurring.find(r => r.merchant === "Netflix");
      expect(netflixRecurring).toBeDefined();
      expect(netflixRecurring?.confidence).toBe('alta');
    });
  });

  describe('RelatÃ³rio Completo', () => {
    test('deve gerar relatÃ³rio com estrutura correta', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      // Verificar estrutura bÃ¡sica
      expect(report.summary).toBeDefined();
      expect(report.top_receitas).toBeDefined();
      expect(report.top_despesas).toBeDefined();
      expect(report.categories).toBeDefined();
      expect(report.anomalies).toBeDefined();
      expect(report.insights).toBeDefined();
      expect(report.raw_transactions).toBeDefined();
    });

    test('deve separar corretamente receitas e despesas', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      // SalÃ¡rio deve estar em top_receitas
      const salaryInReceitas = report.top_receitas.find(r => r.merchant.includes("SalÃ¡rio"));
      expect(salaryInReceitas).toBeDefined();
      
      // SalÃ¡rio NÃƒO deve estar em top_despesas
      const salaryInDespesas = report.top_despesas.find(d => d.merchant.includes("SalÃ¡rio"));
      expect(salaryInDespesas).toBeUndefined();
    });

    test('deve calcular totais corretamente', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      // Verificar se soma das receitas â‰ˆ receitas_mes
      const sumReceitas = report.top_receitas.reduce((sum, r) => sum + r.total, 0);
      expect(Math.abs(sumReceitas - report.summary.receitas_mes)).toBeLessThan(1);
      
      // Verificar se soma das despesas â‰ˆ gastos_mes  
      const sumDespesas = report.top_despesas.reduce((sum, d) => sum + d.total, 0);
      expect(Math.abs(sumDespesas - report.summary.gastos_mes)).toBeLessThan(1);
    });

    test('deve detectar anomalias e gerar insights', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      // Deve ter pelo menos uma anomalia (Gacha)
      expect(report.anomalies.length).toBeGreaterThan(0);
      
      // Deve ter insights
      expect(report.insights.length).toBeGreaterThan(0);
      
      // Deve ter insight sobre anomalia
      const anomalyInsight = report.insights.find(i => i.text.includes("anÃ´mala"));
      expect(anomalyInsight).toBeDefined();
    });
  });

  describe('CritÃ©rios de AceitaÃ§Ã£o', () => {
    test('salÃ¡rio nunca deve aparecer em top_despesas', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      const salaryInDespesas = report.top_despesas.find(d => 
        d.merchant.toLowerCase().includes('salÃ¡rio') || 
        d.merchant.toLowerCase().includes('salary')
      );
      
      expect(salaryInDespesas).toBeUndefined();
    });

    test('deve incluir explanation e confidence em cada anomaly', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      report.anomalies.forEach(anomaly => {
        expect(anomaly.explanation).toBeDefined();
        expect(anomaly.confidence).toBeDefined();
        expect(['alta', 'mÃ©dia', 'baixa']).toContain(anomaly.confidence);
      });
    });

    test('deve tratar variaÃ§Ã£o percentual quando mÃªs anterior for zero', async () => {
      const report = await generateFinancialReport(testTransactions, 0);
      
      // Se nÃ£o hÃ¡ dados do mÃªs anterior, variaÃ§Ã£o deve ser null
      if (report.comparison.previous_month.receitas === 0) {
        expect(report.comparison.variation.receitas_percent).toBeNull();
      }
    });
  });
});

// FunÃ§Ã£o auxiliar para executar testes
export function runTests() {
  console.log('ğŸ§ª Executando testes do sistema de relatÃ³rios financeiros...');
  
  // Teste bÃ¡sico de classificaÃ§Ã£o
  const transaction = testTransactions[0];
  const classification = classifyTransaction(transaction);
  console.log('âœ… ClassificaÃ§Ã£o de salÃ¡rio:', classification);
  
  // Teste de detecÃ§Ã£o de anomalias
  const anomalies = detectAnomalies(testTransactions, 10000, 6966);
  console.log('âœ… Anomalias detectadas:', anomalies.length);
  
  // Teste de relatÃ³rio completo
  generateFinancialReport(testTransactions, 0).then(report => {
    console.log('âœ… RelatÃ³rio gerado com sucesso');
    console.log('ğŸ“Š Resumo:', report.summary);
    console.log('ğŸ† Top receitas:', report.top_receitas.length);
    console.log('ğŸ’¸ Top despesas:', report.top_despesas.length);
    console.log('âš ï¸ Anomalias:', report.anomalies.length);
    console.log('ğŸ’¡ Insights:', report.insights.length);
  });
}
