// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  whatsappInstances WhatsAppInstance[]
  automationRules   AutomationRule[]
  workflows         Workflow[]
}

model WhatsAppInstance {
  id              String   @id @default(cuid())
  userId          String
  name            String
  phone           String?
  phoneId         String?  // WhatsApp Phone Number ID
  status          String   @default("disconnected") // disconnected, connecting, connected, verified
  accessToken     String?  // WhatsApp Cloud API Access Token (criptografado)
  appId           String?  // Meta App ID
  appSecret       String?  // Meta App Secret (criptografado)
  webhookVerifyToken String? // Token para verificação do webhook
  businessAccountId String? // Meta Business Account ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages        Message[]
  automationRules AutomationRule[]
  workflows       Workflow[]
}

model Message {
  id              String   @id @default(cuid())
  instanceId      String
  from            String
  to              String
  body            String
  timestamp       DateTime
  isFromMe        Boolean
  isGroup         Boolean  @default(false)
  messageId       String   @unique
  createdAt       DateTime @default(now())
  
  instance        WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model AutomationRule {
  id          String   @id @default(cuid())
  userId      String
  instanceId  String?
  name        String
  trigger     String   // palavra-chave ou padrão
  response    String   // resposta automática
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance    WhatsAppInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Workflow {
  id          String   @id @default(cuid())
  userId      String
  instanceId  String?
  name        String
  description String?
  trigger     String   // palavra-chave ou padrão que inicia o fluxo
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance    WhatsAppInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  nodes       WorkflowNode[]
  connections WorkflowConnection[]
}

model WorkflowNode {
  id          String   @id @default(cuid())
  workflowId  String
  type        String   // 'message', 'wait', 'questionnaire', 'ai', 'condition'
  positionX   Float    // Posição X no canvas
  positionY   Float    // Posição Y no canvas
  data        String   // JSON com configurações do nó
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  workflow            Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  sourceConnections   WorkflowConnection[] @relation("SourceConnections")
  targetConnections   WorkflowConnection[] @relation("TargetConnections")
}

model WorkflowConnection {
  id          String   @id @default(cuid())
  workflowId  String
  sourceNodeId String  // ID do nó de origem
  targetNodeId String  // ID do nó de destino
  sourceHandle String? // Handle de saída (para condições múltiplas)
  targetHandle String? // Handle de entrada
  createdAt   DateTime @default(now())
  
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  sourceNode  WorkflowNode @relation("SourceConnections", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode  WorkflowNode @relation("TargetConnections", fields: [targetNodeId], references: [id], onDelete: Cascade)
  
  @@index([workflowId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

