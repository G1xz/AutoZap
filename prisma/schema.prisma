// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  profilePictureUrl String? // URL da foto de perfil salva no Cloudinary
  workingHoursConfig String? // JSON com configuração de horários de funcionamento globais
  slotConfig String? // JSON com configuração de slots de agendamento { slotSizeMinutes: number, bufferMinutes?: number }
  businessAddress String? // Endereço completo do estabelecimento (rua, número, bairro, cidade, CEP)
  deliveryPricePerKm Float? // Preço por quilômetro para cálculo de frete
  maxDeliveryDistanceKm Float? // Limite máximo de quilômetros para entrega (null = sem limite)
  messageRetentionDays Int? // Número de dias para manter mensagens (padrão: 90 dias)
  isAdmin   Boolean  @default(false) // Se o usuário é administrador do sistema
  planName  String?  // Nome do plano (ex: "Básico", "Premium", "Enterprise")
  pointsAvailable Int @default(0) // Pontos disponíveis no plano atual
  pointsConsumedThisMonth Int @default(0) // Pontos consumidos no mês atual
  planRenewalDate DateTime? // Data de renovação do plano
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  whatsappInstances   WhatsAppInstance[]
  automationRules     AutomationRule[]
  workflows           Workflow[]
  services            Service[]
  appointments        Appointment[]
  pendingAppointments PendingAppointment[]
  catalogs            Catalog[]
  pixKeys             BusinessPixKey[]
  productInterests    ProductInterest[]
  orders              Order[]
  carts               Cart[]
  aiMetrics           AIMetric[]
  planSubscriptions   PlanSubscription[]
}

model WhatsAppInstance {
  id                    String   @id @default(cuid())
  userId                String
  name                  String
  phone                 String?
  phoneId               String? // WhatsApp Phone Number ID
  status                String   @default("disconnected") // disconnected, connecting, connected, verified
  accessToken           String? // WhatsApp Cloud API Access Token (criptografado)
  appId                 String? // Meta App ID
  appSecret             String? // Meta App Secret (criptografado)
  webhookVerifyToken    String? // Token para verificação do webhook
  businessAccountId     String? // Meta Business Account ID
  active                Boolean  @default(true) // Se false, bloqueia uso (cliente cancelado)
  messagesSentThisMonth Int      @default(0) // Contador de mensagens do mês
  monthlyLimit          Int      @default(1000) // Limite mensal de mensagens
  lastResetDate         DateTime @default(now()) // Data do último reset do contador
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages             Message[]
  automationRules      AutomationRule[]
  workflows            Workflow[]
  conversationStatuses ConversationStatus[]
  appointments         Appointment[]
  pendingAppointments  PendingAppointment[]
  contacts             Contact[]
  productInterests     ProductInterest[]
  orders               Order[]
  carts                Cart[]
  aiMetrics            AIMetric[]
}

model Message {
  id              String   @id @default(cuid())
  instanceId      String
  from            String
  to              String
  body            String
  timestamp       DateTime
  isFromMe        Boolean
  isGroup         Boolean  @default(false)
  messageId       String   @unique
  messageType     String   @default("text") // text, interactive, button, image, video, document, audio
  interactiveData String? // JSON com dados de mensagens interativas (botões, etc)
  mediaUrl        String? // URL da mídia salva no Cloudinary (imagens, vídeos, documentos, áudios)
  createdAt       DateTime @default(now())

  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Índices para melhorar performance das consultas
  @@index([instanceId, timestamp])
  @@index([instanceId, from, timestamp])
  @@index([instanceId, to, isFromMe, timestamp])
  @@index([timestamp])
}

model ConversationStatus {
  id            String   @id @default(cuid())
  instanceId    String
  contactNumber String // Número do contato
  status        String   @default("active") // active, waiting_human, closed
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, contactNumber])
  @@index([instanceId, status])
  @@index([status])
}

model Contact {
  id                String    @id @default(cuid())
  instanceId        String
  phoneNumber       String
  name              String?
  profilePictureUrl String? // URL da foto de perfil salva no Cloudinary
  lastSeen          DateTime? // Última vez que o contato foi visto
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, phoneNumber])
  @@index([instanceId, phoneNumber])
}

model AutomationRule {
  id         String   @id @default(cuid())
  userId     String
  instanceId String?
  name       String
  trigger    String // palavra-chave ou padrão
  response   String // resposta automática
  isActive   Boolean  @default(true)
  priority   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Workflow {
  id                String   @id @default(cuid())
  userId            String
  instanceId        String?
  name              String
  description       String?
  trigger           String // palavra-chave ou padrão que inicia o fluxo
  isActive          Boolean  @default(true)
  usesAI            Boolean  @default(false) // Indica se o workflow usa nós de IA
  isAIOnly          Boolean  @default(false) // Indica se é um fluxo exclusivo de IA (conversação autônoma)
  aiBusinessDetails String? // JSON com detalhes do negócio para a IA (nome, produtos, serviços, etc)
  initialMessage    String? // Mensagem inicial customizada
  initialImageUrl   String? // URL da imagem a ser enviada junto com a mensagem inicial
  sendCatalogInInitialMessage Boolean @default(false) // Se deve enviar o catálogo junto com a mensagem inicial
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance    WhatsAppInstance?    @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  nodes       WorkflowNode[]
  connections WorkflowConnection[]
}

model WorkflowNode {
  id         String   @id @default(cuid())
  workflowId String
  type       String // 'message', 'wait', 'questionnaire', 'ai', 'condition'
  positionX  Float // Posição X no canvas
  positionY  Float // Posição Y no canvas
  data       String // JSON com configurações do nó
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workflow          Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  sourceConnections WorkflowConnection[] @relation("SourceConnections")
  targetConnections WorkflowConnection[] @relation("TargetConnections")
}

model WorkflowConnection {
  id           String   @id @default(cuid())
  workflowId   String
  sourceNodeId String // ID do nó de origem
  targetNodeId String // ID do nó de destino
  sourceHandle String? // Handle de saída (para condições múltiplas)
  targetHandle String? // Handle de entrada
  createdAt    DateTime @default(now())

  workflow   Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  sourceNode WorkflowNode @relation("SourceConnections", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode WorkflowNode @relation("TargetConnections", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

model Service {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  price       Float?
  imageUrl    String?
  isActive    Boolean  @default(true)
  // Promoções (array dinâmico de promoções)
  hasPromotions     Boolean  @default(false) // Se tem promoções ativadas
  promotions        String? // JSON array de promoções: [{value: number, type: "percent"|"value", gatewayLink?: string}]
  pixKeyId           String? // ID da chave Pix selecionada
  // Opções de entrega e pagamento
  deliveryAvailable Boolean  @default(false) // Se permite entrega
  pickupAvailable   Boolean  @default(true) // Se permite retirada (padrão true)
  paymentLink       String? // Link do gateway de pagamento (opcional)
  paymentPixKeyId   String? // ID da chave Pix para pagamento (opcional, diferente da promoção)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  pixKey       BusinessPixKey?   @relation(fields: [pixKeyId], references: [id], onDelete: SetNull)
  paymentPixKey BusinessPixKey? @relation("ServicePaymentPix", fields: [paymentPixKeyId], references: [id], onDelete: SetNull)
  interests    ProductInterest[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([hasPromotions])
}

model Catalog {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  imageUrl    String?  // URL da imagem do catálogo (cardápio/banner)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodes       CatalogNode[]
  connections CatalogConnection[]

  @@index([userId])
  @@index([userId, isActive])
}

model CatalogNode {
  id        String   @id @default(cuid())
  catalogId String
  type      String // 'product', 'service', 'category', 'catalog'
  positionX Float
  positionY Float
  data      String // JSON com configurações do nó
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  catalog           Catalog             @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  sourceConnections CatalogConnection[] @relation("SourceConnections")
  targetConnections CatalogConnection[] @relation("TargetConnections")
}

model CatalogConnection {
  id           String   @id @default(cuid())
  catalogId    String
  sourceNodeId String
  targetNodeId String
  sourceHandle String?
  targetHandle String?
  createdAt    DateTime @default(now())

  catalog    Catalog     @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  sourceNode CatalogNode @relation("SourceConnections", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode CatalogNode @relation("TargetConnections", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@index([catalogId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

model Appointment {
  id            String   @id @default(cuid())
  userId        String
  instanceId    String?
  contactNumber String
  contactName   String?
  date          DateTime // Horário de INÍCIO do agendamento
  endDate       DateTime // Horário de TÉRMINO do agendamento (calculado: date + duration)
  duration      Int? // Duração em minutos (vem do serviço agendado, pode ser null se não especificado)
  description   String?
  status        String   @default("pending") // pending, confirmed, cancelled, completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, date])
  @@index([instanceId, date])
  @@index([status])
  @@index([date, endDate]) // Índice para consultas de sobreposição
}

model PendingAppointment {
  id            String   @id @default(cuid())
  userId        String
  instanceId    String
  contactNumber String
  contactName   String?
  date          String // Data formatada DD/MM/YYYY
  time          String // Hora formatada HH:MM
  duration      Int? // Duração em minutos
  service       String // Nome do serviço
  description   String? // Descrição completa
  expiresAt     DateTime // Quando expira (ex: 1 hora após criação)
  createdAt     DateTime @default(now())

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, contactNumber]) // Apenas um agendamento pendente por contato
  @@index([userId])
  @@index([instanceId, contactNumber])
  @@index([expiresAt]) // Para limpar agendamentos expirados
}

// Chaves Pix do negócio
model BusinessPixKey {
  id          String   @id @default(cuid())
  userId      String
  name        String // Nome/identificação da chave (ex: "Pix Principal", "Pix Vendas")
  pixKey      String // Chave Pix (CPF, CNPJ, email, telefone, chave aleatória)
  pixKeyType  String @default("random") // "cpf", "cnpj", "email", "phone", "random"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  services Service[]
  servicePayments Service[] @relation("ServicePaymentPix")

  @@index([userId])
  @@index([userId, isActive])
}

// Rastreamento de interesse do cliente em produtos/serviços
model ProductInterest {
  id            String   @id @default(cuid())
  userId        String
  instanceId    String
  contactNumber String
  productId     String // ID do produto/serviço (pode ser Service.id ou CatalogNode.id)
  productType   String @default("service") // "service" ou "catalog"
  productName   String // Nome do produto (para referência rápida)
  interestType  String @default("viewed") // "viewed", "asked_info", "requested_discount"
  status        String @default("pending") // "pending", "converted", "abandoned"
  lastInteraction DateTime @default(now()) // Última vez que demonstrou interesse
  convertedAt   DateTime? // Data em que converteu (comprou)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  // Relação opcional com Service - apenas quando productType é 'service'
  // Quando productType é 'catalog', productId é um CatalogNode.id e não há relação
  service  Service?         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([instanceId, contactNumber, productId, productType]) // Um interesse por produto por contato
  @@index([userId])
  @@index([instanceId, contactNumber])
  @@index([status])
  @@index([lastInteraction])
}

// Pedidos/Ordens de compra
model Order {
  id            String   @id @default(cuid())
  userId        String
  instanceId    String
  contactNumber String
  contactName   String?
  deliveryType  String   @default("pickup") // "pickup" ou "delivery"
  deliveryAddress String? // Endereço completo de entrega (se deliveryType = "delivery")
  freightAmount Float? // Valor do frete calculado (se deliveryType = "delivery")
  status        String   @default("pending") // "pending", "confirmed", "preparing", "ready", "delivered", "picked_up", "cancelled"
  totalAmount   Float    @default(0)
  paymentMethod String? // "pix", "gateway", "cash" (se não tiver link)
  paymentLink   String? // Link de pagamento se houver
  paymentPixKey String? // Chave Pix se houver
  notes         String? // Observações do cliente
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime? // Quando foi concluído (entregue ou retirado)

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance   WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  items      OrderItem[]

  @@index([userId])
  @@index([instanceId])
  @@index([instanceId, contactNumber])
  @@index([status])
  @@index([createdAt])
}

// Itens do pedido
model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  productId     String // ID do produto/serviço (Service.id ou CatalogNode.id)
  productType   String   @default("service") // "service" ou "catalog"
  productName   String
  quantity      Int      @default(1)
  unitPrice     Float
  totalPrice    Float
  notes         String? // Observações específicas do item
  createdAt     DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId, productType])
}

// Carrinho de compras (persistido no banco para evitar perda entre requisições)
model Cart {
  id            String   @id @default(cuid())
  userId        String
  instanceId    String
  contactNumber String   // Sempre normalizado (apenas números)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  items    CartItem[]

  @@unique([instanceId, contactNumber]) // Um carrinho por contato por instância
  @@index([userId])
  @@index([instanceId, contactNumber])
  @@index([updatedAt]) // Para limpar carrinhos antigos
}

// Itens do carrinho (relacional)
model CartItem {
  id            String   @id @default(cuid())
  cartId        String
  productId     String   // ID do produto/serviço
  productType   String   @default("service") // "service" ou "catalog"
  productName   String
  quantity      Int      @default(1)
  unitPrice     Float
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  cart          Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, productType]) // Garante que um item único só exista uma vez no carrinho
  @@index([cartId])
}

// Métricas de uso de IA (OpenAI, etc)
model AIMetric {
  id              String   @id @default(cuid())
  userId          String?
  instanceId      String?
  model           String   // Ex: gpt-3.5-turbo, gpt-4
  promptTokens    Int      @default(0)
  completionTokens Int    @default(0)
  totalTokens     Int      @default(0)
  cost            Float    @default(0) // Custo em USD (apenas para administrador)
  pointsConsumed  Int      @default(0) // Pontos consumidos nesta requisição
  duration        Int      @default(0) // Duração em milissegundos
  cached          Boolean  @default(false)
  endpoint        String?  // Ex: chat, transcribe, vision
  createdAt       DateTime @default(now())

  user     User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance?  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([model])
}

// Planos disponíveis para os usuários
model Plan {
  id              String   @id @default(cuid())
  name            String   @unique // "Básico", "Pro", "Business", "Enterprise"
  displayName     String   // Nome de exibição
  price           Float    // Preço em R$
  adminPercentage Float    // Porcentagem que fica para o admin (ex: 0.30 = 30%)
  pointsAmount    Int      // Quantidade de pontos que o cliente recebe
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subscriptions   PlanSubscription[]

  @@index([isActive])
}

// Assinaturas de planos dos usuários
model PlanSubscription {
  id              String   @id @default(cuid())
  userId          String
  planId          String
  status          String   @default("active") // "active", "cancelled", "expired"
  startDate       DateTime @default(now())
  endDate         DateTime // Data de renovação
  pointsReceived  Int      // Pontos recebidos nesta assinatura
  pricePaid       Float    // Valor pago nesta assinatura
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan     @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([userId, status])
  @@index([status])
  @@index([endDate])
}

